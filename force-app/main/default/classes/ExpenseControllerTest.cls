@isTest
public class ExpenseControllerTest {

    @testSetup
    static void setupTestData() {
        // âœ… Insert test expenses
        List<Expense__c> testExpenses = new List<Expense__c>();

        for (Integer i = 1; i <= 3; i++) {
            testExpenses.add(new Expense__c(
                Amount__c = 100 * i,
                Category__c = 'Test Category ' + i,
                Expense_Date__c = Date.today().addDays(-i),
                Currency__c = 'USD'
            ));
        }
        insert testExpenses;
        System.debug('âœ… Inserted ' + testExpenses.size() + ' test records.');
    }

    @isTest
    static void testSaveExpense() {
        Test.startTest();
        // âœ… Call the method with test data
        ExpenseController.saveExpense(150, 'Food', Date.today(), 'EUR');

        // âœ… Verify the record was created
        Expense__c savedExpense = [SELECT Id, Amount__c, Category__c, Currency__c FROM Expense__c WHERE Currency__c = 'EUR' LIMIT 1];

        System.assertNotEquals(null, savedExpense.Id, 'âŒ Expense was not saved!');
        System.assertEquals(150, savedExpense.Amount__c, 'âŒ Amount mismatch!');
        System.assertEquals('Food', savedExpense.Category__c, 'âŒ Category mismatch!');
        System.assertEquals('EUR', savedExpense.Currency__c, 'âŒ Currency mismatch!');
        Test.stopTest();
    }

    @isTest
    static void testSaveExpenseWithMissingFields() {
        Test.startTest();
        try {
            // âœ… Missing category should throw an error
            ExpenseController.saveExpense(150, null, Date.today(), 'USD');
            System.assert(false, 'âŒ Expected an AuraHandledException for missing fields.');
        } catch (AuraHandledException e) {
            System.debug('âœ… Caught expected AuraHandledException: ' + e.getMessage());
            System.assert(e.getMessage().contains('âŒ Missing required fields'), 'âŒ Incorrect error message.');
        }
        Test.stopTest();
    }

    @isTest
    static void testSaveExpenseDmlException() {
        Test.startTest();
        try {
            // âœ… Try inserting an invalid record
            ExpenseController.saveExpense(null, 'Bills', Date.today(), 'USD');
            System.assert(false, 'âŒ Expected an AuraHandledException for DML error.');
        } catch (AuraHandledException e) {
            System.debug('âœ… Caught expected DML Exception: ' + e.getMessage());
            System.assert(e.getMessage().contains('âŒ Error saving expense'), 'âŒ Incorrect DML error message.');
        }
        Test.stopTest();
    }

    @isTest
    static void testGetConversionRate() {
        Test.startTest();
        // âœ… Mock API Response
        Test.setMock(HttpCalloutMock.class, new MockExchangeRateResponse());

        Decimal conversionRate = ExpenseController.getConversionRate('TRY');
        System.debug('ğŸŒ Mocked Conversion Rate: ' + conversionRate);

        // âœ… Ensure the conversion rate is as expected
        System.assert(conversionRate > 0, 'âŒ Conversion rate should be greater than 0!');
        System.assert(conversionRate < 1, 'âŒ TRY to USD rate should be a fraction!');
        Test.stopTest();
    }

    @isTest
    static void testGetConversionRateWithNullCurrency() {
        Test.startTest();
        // âœ… Mock API Response
        Test.setMock(HttpCalloutMock.class, new MockExchangeRateResponse());

        Decimal conversionRate = ExpenseController.getConversionRate(null);
        System.debug('ğŸŒ Mocked Conversion Rate (defaulted): ' + conversionRate);

        // âœ… Should default to USD
        System.assertEquals(1, conversionRate, 'âŒ Default conversion rate should be 1 for USD.');
        Test.stopTest();
    }

    @isTest
    static void testGetExpenses() {
        Test.startTest();
        // âœ… Call the method
        List<Expense__c> expenses = ExpenseController.getExpenses();

        // âœ… Ensure it returns at least the test records
        System.assert(expenses.size() > 0, 'âŒ No expenses returned!');
        System.assertEquals(3, expenses.size(), 'âŒ Unexpected number of expenses!');
        Test.stopTest();
    }
}